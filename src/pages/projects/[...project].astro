---
import { getCollection, render } from "astro:content";
import { Image } from "astro:assets";
import Layout from "@/layouts/layout.astro";
import Prose from "@/components/prose.astro";
import ContentNavigator from "@/components/content-navigator.astro";

export async function getStaticPaths() {
  // Ascending order (oldest to newest), for the content navigation component
  const projects = (await getCollection("projects")).sort(
    (a, b) => a.data.pubDate.valueOf() - b.data.pubDate.valueOf()
  );

  return projects.map((project, index) => ({
    params: { project: project.id },
    props: { project, index, projects },
  }));
}

const { project, index, projects } = Astro.props;
const { title, description, type, images, deploy_url, repo_url, tech_stack } = project.data;
const image_index = 0;

const { Content } = await render(project);

const displayBtnText = type === "App" ? "Deployment" : "Play";
---

<Layout title={title + " | Edward Vonschondorf"} description={description}>
  <article
    class="z-10 container mx-auto my-auto max-w-4xl overflow-clip rounded-3xl border border-stone-700 backdrop-blur-xs">
    <div class="flex items-baseline justify-between border-b border-stone-700 bg-stone-900/40 px-6 py-3">
      <h1 class="text-xl font-bold text-stone-100">{title}</h1>
      <span class="text-sm text-stone-500">{type}</span>
    </div>
    <section class="flex flex-col-reverse sm:flex-row">
      <div class="sm:w-2/3 sm:divide-y sm:divide-stone-700">
        <a
          href={`/projects/${project.id}/gallery/${image_index}`}
          class="hidden aspect-square border-r border-stone-700 bg-black p-6 transition-all duration-300 ease-in-out hover:p-0 sm:block">
          <Image src={images[0]} class="size-full object-contain" alt={`${title} screenshot`} />
        </a>
        <div
          class="grid grid-cols-2 divide-x divide-y divide-stone-700 overflow-clip border-t border-stone-700 bg-black sm:grid-cols-4 sm:divide-y-0 sm:border-t-0 sm:border-r">
          {
            // Fill up to 4 columns with images or empty strings
            Array.from({ length: 4 }, (_, i) => images[i] ?? "").map((img, index) =>
              img ? (
                <a
                  href={`/projects/${project.id}/gallery/${index}`}
                  class="p-3 transition-all duration-300 ease-in-out hover:p-0">
                  <Image src={img} class="aspect-square object-contain" alt={`${title} screenshot`} />
                </a>
              ) : (
                <div class="aspect-square p-3" />
              )
            )
          }
        </div>
      </div>
      <div class="sm:w-1/3">
        <Image src={project.data.banner} alt={project.data.title} class={"w-full border-b border-stone-700"} />
        <div class="space-y-3 px-3 pt-3">
          <p class="text-stone-300">{project.data.description}</p>
          <a
            href={deploy_url}
            target="_blank"
            rel="noopener noreferrer external"
            class="block cursor-pointer rounded-lg border border-orange-800 bg-orange-800/50 py-2 text-center text-sm font-bold text-orange-200 transition-colors duration-300 ease-in-out hover:bg-orange-800/75 hover:text-white">
            {displayBtnText}
          </a>
          <a
            href={repo_url}
            target="_blank"
            rel="noopener noreferrer external"
            class="block cursor-pointer rounded-lg border border-stone-600 bg-stone-800/50 py-2 text-center text-sm font-medium text-stone-200 transition-all duration-300 ease-in-out hover:bg-stone-800/75 hover:text-white">
            Repository
          </a>
        </div>
        <ul class="flex flex-wrap gap-3 p-3">
          {
            tech_stack.map((tech) => (
              <li class="rounded-lg border px-3 py-1 text-sm font-medium text-stone-500">{tech}</li>
            ))
          }
        </ul>
      </div>
    </section>
    <section class="border-t border-stone-700 p-3 md:p-6">
      <Prose>
        <Content />
      </Prose>
    </section>
    <ContentNavigator items={projects} currentIndex={index} basePath="projects" contentType="Projects" />
  </article>
</Layout>
